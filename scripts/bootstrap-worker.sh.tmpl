
#!/bin/bash
set -e

# Update and install Docker
yum update -y
amazon-linux-extras install docker -y
systemctl enable docker
systemctl start docker

# Disable swap (kubeadm will complain otherwise)
swapoff -a
sed -i '/swap/d' /etc/fstab

# Add the updated Kubernetes repo (change v1.29 if needed)
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key
EOF

# Install Kubernetes components
yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes
systemctl enable kubelet
systemctl start kubelet

# Get the master IP injected from Terraform
master_ip="${master_ip}"

echo "[INFO] Attempting to retrieve join command from master at $MASTER_IP..."

# Copy the join script from the master node
scp -q -o StrictHostKeyChecking=no ec2-user@${master_ip}:/joincommand.sh /joincommand.sh
if [ $? -ne 0 ]; then
  echo "[ERROR] Failed to retrieve /joincommand.sh from master node at $MASTER_IP"
  exit 1
fi

echo "[INFO] Retrieved joincommand.sh successfully."

# Make it executable and run it
chmod +x /joincommand.sh
bash /joincommand.sh

echo "[INFO] Worker node successfully joined the cluster."
