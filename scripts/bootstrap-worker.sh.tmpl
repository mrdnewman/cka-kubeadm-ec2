

#!/bin/bash
set -e

# Update and install Docker
yum update -y
amazon-linux-extras install docker -y
systemctl enable docker
systemctl start docker

# Disable swap (kubeadm hates swap)
swapoff -a
sed -i '/swap/d' /etc/fstab

# Add Kubernetes repo
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key
EOF

# Install Kubernetes components
yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes

systemctl enable kubelet
systemctl start kubelet

# Wait for master to finish initializing and expose join script
echo "Waiting for master to be ready..."
until ssh -o StrictHostKeyChecking=no ec2-user@${master_ip} "test -f /joincommand.sh"; do
  echo "Master not ready yet. Sleeping 10s..."
  sleep 10
done

# Fetch join command
scp -o StrictHostKeyChecking=no ec2-user@${master_ip}:/joincommand.sh /joincommand.sh
chmod +x /joincommand.sh
bash /joincommand.sh

